---
import Layout from "../../../layouts/Layout.astro";
import ReadingListForm from "../../../components/ReadingListForm.astro";
import { actions } from "astro:actions";
import { db } from "../../../lib/db";
import { readingListItem } from "../../../lib/schema";
import { eq, and } from "drizzle-orm";

if (!Astro.locals.session) {
  return Astro.redirect("/reading-list/login");
}

const { id } = Astro.params;

if (!id) {
  return Astro.redirect("/reading-list/dashboard");
}

const [item] = await db
  .select()
  .from(readingListItem)
  .where(
    and(
      eq(readingListItem.id, id),
      eq(readingListItem.userId, Astro.locals.user!.id)
    )
  );

if (!item) {
  return Astro.redirect("/reading-list/dashboard");
}

const result = Astro.getActionResult(actions.updateReadingListItem);
if (result && !result.error) {
  return Astro.redirect("/reading-list/dashboard");
}
---

<Layout title="Edit Reading List Item">
  <div class="flex flex-col gap-6">
    <div class="flex items-center justify-between">
      <h1 class="text-2xl md:text-4xl font-bold font-garamond">Edit Item</h1>
      <a
        href="/reading-list/dashboard"
        class="text-text-muted hover:text-text transition-colors"
      >
        Back to Dashboard
      </a>
    </div>

    {result?.error && (
      <div class="bg-red-900/50 border border-red-700 text-red-200 px-4 py-3 rounded">
        {result.error.message || "Failed to update item"}
      </div>
    )}

    <ReadingListForm
      action={actions.updateReadingListItem}
      item={item}
      submitLabel="Update Item"
    />
  </div>
</Layout>
